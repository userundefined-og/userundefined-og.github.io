<!doctype html>

<html lang="en-us">

<head>
  <title>Constraint Propagation - Blog of the Dad</title>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="The HTML5 Herald" />
<meta name="author" content="Andrei" /><meta property="og:title" content="Constraint Propagation" />
<meta property="og:description" content="Constraint propagation is one of the key mechanisms that allows constructive search to efficiently explore huge search spaces. It does so by applying constraints whenever search state changes to remove parts of search space that cannot contain solutions.
In this post I&rsquo;ll cover two constraint propagation techniques: forward checking and arc consistency. As these techniques apply to variables&rsquo; live domains, I&rsquo;ll start by defining what that is first, and then dive into constraint propagation itself." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.dawnofthe.dad/posts/constraint-propagation/" /><meta property="og:image" content="https://blog.dawnofthe.dad/4q-prop.svg" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-04T15:59:06-07:00" />
<meta property="article:modified_time" content="2023-09-04T15:59:06-07:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://blog.dawnofthe.dad/4q-prop.svg"/>

<meta name="twitter:title" content="Constraint Propagation"/>
<meta name="twitter:description" content="Constraint propagation is one of the key mechanisms that allows constructive search to efficiently explore huge search spaces. It does so by applying constraints whenever search state changes to remove parts of search space that cannot contain solutions.
In this post I&rsquo;ll cover two constraint propagation techniques: forward checking and arc consistency. As these techniques apply to variables&rsquo; live domains, I&rsquo;ll start by defining what that is first, and then dive into constraint propagation itself."/>

<meta name="generator" content="Hugo 0.117.0">
    
    <script src="/js/mathjax-config.js" defer></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://blog.dawnofthe.dad/fontawesome/css/all.min.css" />
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  
  
  <link rel="stylesheet" type="text/css" href="/css/styles.css" />
</head>

<body>
  <div id="container">
    <header>
      
      <h1>
        <a href="/">Blog of the Dad</a>
      </h1>

      <ul id="social-media">
             <li>
               <a href="https://twitter.com/userundefinedrd" title="Twitter">
               <i class="fab fa-twitter fa-lg"></i>
               </a>
             </li>
      </ul>
      
      <p><em>Don’t eat me. I have a wife and kids. Eat them.</em></p>
      
    </header>

    
<nav>
    <ul>
        
    </ul>
</nav>


    <main>




<article>

    <h1>Constraint Propagation</h1>

    
      <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2023-09-04T15:59:06-07:00">Sep 4, 2023</time>
        </li>
        
        

        
        <li>
            <em>
                
                    
                    <a href="/tags/algorithms">#Algorithms</a>
                
                    , 
                    <a href="/tags/constructive-search">#Constructive search</a>
                
                    , 
                    <a href="/tags/go">#Go</a>
                
            </em>
        </li>
        

        <li>7 minute read</li>
    </ul>
</aside>

    

    
      
<div class="featured_image">
    <a href="https://blog.dawnofthe.dad/posts/constraint-propagation/" title="Constraint Propagation">
        <img src="/4q-prop.svg">
    </a>
</div>


    

    <p>Constraint propagation is one of the key mechanisms that allows constructive search to efficiently explore huge search spaces. It does so by applying constraints whenever search state changes to remove parts of search space that cannot contain solutions.</p>
<p>In this post I&rsquo;ll cover two constraint propagation techniques: forward checking and arc consistency. As these techniques apply to variables&rsquo; live domains, I&rsquo;ll start by defining what that is first, and then dive into constraint propagation itself.</p>
<h2 id="variables-and-domains">Variables and domains</h2>
<p>Variables in CSPs are associated with their <em>domains</em>, for example, in <a href="https://blog.dawnofthe.dad/posts/solver-basics/">N-queens problem</a> each variable represents a queen in a particular column and its domain represents the N possible rows that the queen may be assigned to; in order to find a solution to the CSP we must assign variables to exactly one value from their respective domains such that no constraints are violated. Before we discuss constraint propagation it would help to define another concept - <em>live domain</em>.</p>
<p><strong>Live domain</strong> of a variable V is a subset of values from V&rsquo;s domain that may still be part of a solution. Unlike domain of a variable, which is static and defined once as part of the CSP, live domain changes throughout the search:</p>
<ul>
<li>Decisions made during search can directly affect a variable&rsquo;s live domain. For example, choosing to assign a queen to a particular row, let&rsquo;s call it <em>k</em>, will mutate its live domain to be just that value; i.e., {<em>k</em>}.</li>
<li>Similarly, some decisions may result in <em>pruning</em> values from the live domain, like stating that a queen cannot be on row <em>m</em>, and that would lead us to remove <em>m</em> from the live domain of the variable for that queen.</li>
<li>Constraint propagation is the other, key mechanism that prunes values from live domain of variables, by removing values that are guaranteed to not be part of a solution given the current search state.</li>
<li>The cases above all remove values from live domains, and apply as we traverse deeper into the search tree. When we go back up the search tree it is important to remember to restore variables&rsquo; live domains.</li>
</ul>
<h2 id="constraint-propagation">Constraint propagation</h2>
<p>As search traverses deeper into a particular subtree a few things happen:</p>
<ul>
<li>Decisions made on the path from the current node to the root reduce the search space, with the goal of finding a solution, or proving none exists in this subtree.</li>
<li>As those decisions are made, and as mentioned above, live domains of variables will be reduced, reflecting the reduction of search space as the search traverses deeper down the search tree.</li>
</ul>
<p><strong>Constraint propagation</strong> is the idea that when live domains of variables change, we have the opportunity to examine constraints of the CSP and use those to <em>further</em> reduce live domains by removing (aka pruning) values that would otherwise be guaranteed to violate constraints. For example, with N-queens, whenever we assign some queen to row <em>k</em> we know that the other queens cannot be on row <em>k</em> now without being attacked, and can remove <em>k</em> from their live domains. Let&rsquo;s look at the two constraint propagation algorithms, and then look at how one might code those up.</p>
<h3 id="forward-checking">Forward checking</h3>
<p>Forward checking is a relatively simple and effective constraint propagation technique that can be summed up as follows:</p>
<ol>
<li>When a variable V&rsquo;s live domain changes, grab all constraints that involve the variable.</li>
<li>Look at each constraint one at a time. For each such constraint C, look at all the <em>other</em> variables that are part of the constraint.</li>
<li>For each such variable U ≠ V of C look at the live domain of U and see which values of U&rsquo;s live domain can still be a part of a solution without violating C. Any values that don&rsquo;t meet this criterion are removed from U&rsquo;s live domain.</li>
</ol>
<p>This last part is a bit tricky. Let&rsquo;s look at the simplest case first, where we have binary constraints, like the diagonal constraint from N-queens, and just assigned one of the variables (i.e., placed one of the queens):</p>
<ul>
<li>In this case, as we apply forward checking, we want to adjust the live domain of the other queen to remove values (row numbers) that would now be diagonally under attack.</li>
<li>We&rsquo;d apply this to all the constraints that the assigned queen is involved in, thus updating live domains of possibly many other queens.</li>
</ul>
<p>The more general case can involve constraints with many variables involved, like <em>all-different</em> constraint, and possibly only partial live-domain changes, rather than reductions to a single assigned value. In this case we need to rely on <strong>supports</strong> of a constraint. A support is defined as a set of assignments of values to all variables involved in a constraint that do not violate the constraint. Coming back to constraint propagation, the last step of forward checking means that as we look at live domains of variables, we should remove any values that can no longer be supported given the current state of search.</p>
<p>Let&rsquo;s explain this last bit with an example, this time looking at <em>all-different</em> constraint defined on 4 queens, which tells us that all 4 queens must be assigned to unique rows. Now, suppose that:</p>
<ul>
<li>Initially Q1 (using the same notation as in the <a href="https://blog.dawnofthe.dad/posts/solver-basics/">older post</a>) has live domain of {1, 2, 3}, Q2 has live domain of {1, 2}, Q3 has live domain of {3, 4} and Q4 has live domain of {3}.</li>
<li>If we assign Q1 to 3, we will end up removing 3 from live domain of Q3 and Q4.</li>
</ul>
<p>One interesting and important bit about this simple example is that this would mean that Q4 now has an empty live domain. This is referred to as a <em>wipeout</em> and means that we won&rsquo;t be able to find a solution in this part of the search space <strong>and must backtrack</strong>. This is one of the key benefits of constraint propagation - by doing a bit of work up-front, not only can we reduce work further down in the search tree, but we can sometimes detect infeasibility (i.e., absence of a solution) early, and backtrack right away.</p>
<p>Oh, and the image at the top is basically an example of applying forward checking to 4-queens after placing Q1 on row 1.</p>
<h3 id="arc-consistency">Arc consistency</h3>
<p>Arc consistency is another constraint propagation technique that is more powerful (and more expensive to evaluate) than forward checking. Tersely speaking it:</p>
<ol>
<li>Keeps track of variables whose live domains have changed. It starts by seeding a set S of variables with the variable that was affected by the latest decision.</li>
<li>Removes a variable from S and applies forward checking as described above. As this is done, any variables with live domain reductions are added to S.</li>
<li>Keeps going until S becomes empty, meaning no further live domain changes happen.</li>
</ol>
<p>Arc consistency generally leads to fewer backtracks than forward-checking, as infeasibility can be detected faster, however arc consistency requires more constraint evaluations and can be significantly slower per iteration. As such, whether you should use forward checking or arc consistency tends to depend on the problem <strong>and</strong> the implementation of constraints. Benchmarking generally can help you choose the right constraint propagation approach.</p>
<h3 id="code">Code</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#75715e">// propagate returns true when no live domains are wiped out.
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Search</span>) <span style="color:#a6e22e">propagate</span>(<span style="color:#a6e22e">arcConsistency</span> <span style="color:#66d9ef">bool</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>  <span style="color:#a6e22e">changedVars</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Variable</span>]<span style="color:#66d9ef">bool</span>{}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>  <span style="color:#a6e22e">changedVars</span>[<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">current</span>.<span style="color:#a6e22e">decision</span>.<span style="color:#a6e22e">variable</span>] = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>  <span style="color:#66d9ef">for</span> len(<span style="color:#a6e22e">changedVars</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">nextV</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Variable</span> = <span style="color:#a6e22e">pop</span>(<span style="color:#a6e22e">changedVars</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">problem</span>.<span style="color:#a6e22e">ConstraintsFor</span>(<span style="color:#a6e22e">nextV</span>) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>      <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">cv</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Variables</span>() {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>        <span style="color:#a6e22e">liveDomainChanged</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>        <span style="color:#a6e22e">cv</span>.<span style="color:#a6e22e">LiveDomain</span>().<span style="color:#a6e22e">ForEachValue</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">value</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>          <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Supported</span>(<span style="color:#a6e22e">cv</span>, <span style="color:#a6e22e">value</span>) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>            <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">prune</span>(<span style="color:#a6e22e">cv</span>, <span style="color:#a6e22e">val</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>            <span style="color:#a6e22e">liveDomainChanged</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>          }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>        })
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>        <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">liveDomainChanged</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>          <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cv</span>.<span style="color:#a6e22e">WipedOut</span>() {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">arcConsistency</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>          <span style="color:#a6e22e">changedVars</span>[<span style="color:#a6e22e">cv</span>] = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>      }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>  }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>}
</span></span></code></pre></div><p>The block above applies constraint propagation, and the logic between forward checking and arc consistency is really just about adding changed variables to <code>changedVars</code> on lines 23-25, and is gated by the bool passed to  <code>propagate()</code> where <code>arcConsistency</code> being false means that forward checking will be applied instead. The key parts are:</p>
<ul>
<li>Lines 3-5 initialize <code>changedVars</code> and keep going so long as this &ldquo;set&rdquo; isn&rsquo;t empty.</li>
<li>Line 6 grabs the next variable <code>nextV</code> to process.</li>
<li>Line 7 goes through all the constraints <code>c</code> of <code>nextV</code>.</li>
<li>Line 8 goes through all variables <code>cv</code> of <code>c</code>.</li>
<li>Lines 9-22 apply the core of forward checking algorithm described above by checking all values of <code>cv</code>&rsquo;s live domain for supports of constraint <code>c</code>, any that are not supported are removed, and if the entire domain of <code>cv</code> is wiped out (made empty), <code>propagate()</code> ends indicating that no solution exists.</li>
</ul>

</article>


<section class="post-nav">
    <ul>
        <li>
        
            <a href="https://blog.dawnofthe.dad/posts/search-algo-in-go/"><i class="fa fa-chevron-circle-left"></i> Search Algo in Go</a>
        
        </li>
        <li>
        
        </li>
    </ul>
</section>
  
    
    
  





</main>
    <footer>
        <ul>
            <li>
                <h6>
                    Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a></h6>
            </li>
            
            
        </ul>
    </footer>
</div>
<script src="/js/scripts.js"></script>

  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WS2FCBYJLF"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-WS2FCBYJLF', { 'anonymize_ip': false });
}
</script>



</body>

</html>

